
<div class="calorie-body">
  <div class="calorie-username">
    <p>
      <h1>{{#each results}}{{#if @last}}{{this.user_id}}'s Calorie Tracker{{/if}}{{/each}}</h1>
    </p>
  </div>

  <h2>Today's Progress</h2>
  <div class="calorie-progress">
    <div class="calorie-progress-bar" role="progressbar" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100" style="min-width: {{#each results}}{{#if @last}}{{this.calorie_in_percent}}{{/if}}{{/each}}%" id="calorie-bar">
      Calorie's In: {{#each results}}{{#if @last}}{{this.daily_calories}}{{/if}}{{/each}}
    </div>
  </div>

  <div>
    <div class="calorie-status">
      <p>Status: {{#each results}}{{#if @last}}{{this.calorie_status}}{{/if}}{{/each}}</p>
    </div>

    <div class="calorie-status">
      <p>Calories left: {{#each results}}{{#if @last}}{{this.calorie_left}}{{/if}}{{/each}}</p>
    </div>
  </div>

  <div class="calorie-rec">
    <p>
      <div style="width: 20%; float: left; margin: 0 0 0 0">
        <h3>Recipe Recommendations: </h3>
        <a id = "recipe_link" href=""><h5 id = "recipe_title">Recommendations</h5></a>
      </div>
      <div class="bs-example" style=" margin: 0 -51px 0 0; width: 80%; float: right; ">
        <div id="recipeCarousel" class="carousel slide" data-interval="3000" data-ride="carousel">
            <!-- Carousel indicators -->
            <!-- Wrapper for carousel items -->
            <div class="carousel-inner">
                <div class="carousel-item active">                    
                    <div class="carousel-caption d-none d-md-block">
                    </div>
                    <div><img id='carousel_pic' alt="-1" src="/images/yeti.jpg" width="700px" height="500px"></div>
                </div>
            </div>
            <!-- Carousel controls -->
            <a class="carousel-control-prev">
                <span class="carousel-control-prev-icon"></span>
            </a>
            <a class="carousel-control-next">
                <span class="carousel-control-next-icon"></span>
            </a>
        </div>
      </p>
    </div>

    <p>
      <div class="calories-info" >
        <div  style="width: 50%; float: left; margin: 0 0 0 0">
          <table class="calories-table" id="calorie-table" border="1" width="90%" padding="10px" text>
            <tr>
              <th style="text-align:center" colspan="6">Your calories</th>
            </tr>
            <tr>
              <td>Date</td>
              <td>Goal</td>
              <td>Consumed</td>
              <td>Deficit</td>
              <td>Surplus</td>
            </tr>

              {{#each results}}
              <tr>
              <td>{{this.calorie_date}}</td>
              <td>2000</td>
              <td>{{this.calorie_in}}</td>
              <td>{{this.calorie_left}}</td>
              <td>{{this.calorie_surplus}}</td>
              </tr>
              {{/each}}

          </table>
        </div>

        <div class="calories-add" style="width: 50%; float: right; margin: 0 0 0 0">
          <table border="1" width="90%">
            <tr>
              <th style="text-align:center">Add calories</th>
            </tr>
            <tr>
              <td style="text-align:left">
                <form action="/calories/data" method="post">
                  <div class="block">
                    <label>Date:</label>
                    <input size="16" type="date" name="date" id="date" required>
                  </div>
                  <div class="block">
                    <label>Calories:</label>
                    <input size="16" type="text" name="calories" id="calories" required><br>
                  </div>
                  <input type="submit" value="Submit" name="submitCalories">
                </form>
              </td>
            </tr>
          </table>
        </div>
      </div>
    </p>
  </div>
</div>


<script>
  $(document).ready(function(){
      // Activate carousel
      $("#recipeCarousel").carousel();

      // Enable carousel control

      //****************************************************//
      window.location.recipe_rec = [];
      $.ajax({ type: "GET",
      url: "/calorierec",
      async: true,
      success : function(res)
      {
      for (i = 0; i < res.results.length; i++){
      window.location.recipe_rec.push({
                                  "recipe_id": res.results[i].recipe_id,
                                  "recipe_name": res.results[i].recipe_name,
                                  "recipe_img": res.results[i].recipe_img,
                                  "total_calories": res.results[i].total_calories});
      }
      }
      });

      function carousel_inc(index){
                
                $("#carousel_pic").attr("src","/images/" + window.location.recipe_rec[++index].recipe_img);
                $("#recipe_title").text(window.location.recipe_rec[index].recipe_name);
                $("#carousel_pic").attr("alt", index);
                $("#recipe_link").attr("href", "/" + window.location.recipe_rec[index].recipe_id);
      }

      function carousel_dec(index){
                $("#carousel_pic").attr("src","/images/" + window.location.recipe_rec[--index].recipe_img);
                $("#recipe_title").text(window.location.recipe_rec[index].recipe_name);
                $("#carousel_pic").attr("alt", index);
                $("#recipe_link").attr("href", "/" + window.location.recipe_rec[index].recipe_id);
      }

      function carousel_fix(index){
                    $("#carousel_pic").attr("src","/images/" + window.location.recipe_rec[index].recipe_img);
                    $("#recipe_title").text(window.location.recipe_rec[index].recipe_name);
                    $("#carousel_pic").attr("alt", index);
                    $("#recipe_link").attr("href", "/" + window.location.recipe_rec[index].recipe_id);
      }


      $(".carousel-control-next").click(function(){
              var image_index = $("#carousel_pic").attr("alt");
              console.log(image_index);
              if (image_index < window.location.recipe_rec.length - 1){
                      carousel_inc(image_index);
              }else{
                      carousel_fix(0);
              }
              
      });    

      $(".carousel-control-prev").click(function(){
              var image_index = $("#carousel_pic").attr("alt");
              if (image_index > 0){
                      carousel_dec(image_index)
              }else{
                    carousel_fix(window.location.recipe_rec.length - 1);
              }
      });    
      //****************************************************//  
  });
</script>

<script>
  var total_calories = 0;
  var counter = 0;

  console.log("{{#each results}}{{#if @last}}{{this.calorie_date}}{{/if}}{{/each}}");
  console.log(date);
  $('[name="submitCalories"]').click(myFunction);

  function myFunction() {
    var calorietable = document.getElementById("calorie-table");
    var caloriebar = document.getElementById("calorie-bar");
    console.log(calorietable);
    var z = document.createElement("tr");

    var date = document.getElementById("date").value;
    var calories = document.getElementById("calories").value;
    if(counter == 0){
      total_calories = Number({{#each results}}{{#if @last}}{{this.daily_calories}}{{/if}}{{/each}}) + Number(calories, 10);
    } else {
      total_calories = total_calories + Number(calories, 10);
    }

    if(date == "{{#each results}}{{#if @last}}{{this.calorie_date}}{{/if}}{{/each}}")
      caloriebar.innerHTML = "Calories in: " + total_calories;

    counter++;
    console.log(counter);
  }
</script>
